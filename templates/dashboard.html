<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดการดูแลผู้ใช้</title>
    <style>
        :root {
            --bg: #f5f7fb;
            --surface: #ffffff;
            --accent: #4f46e5;
            --accent-muted: #eef2ff;
            --text: #1f2933;
            --muted: #6b7280;
            --border: #e5e7eb;
            --high: #dc2626;
            --medium: #f59e0b;
            --low: #16a34a;
            --unknown: #6b7280;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        header.page-header {
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            color: #fff;
            padding: 2.5rem 0;
        }

        .container {
            width: min(1120px, 92vw);
            margin: 0 auto;
        }

        header h1 {
            margin: 0;
            font-size: clamp(1.8rem, 2.6vw, 2.4rem);
        }

        header p {
            margin: 0.5rem 0 0;
            color: rgba(255, 255, 255, 0.82);
        }

        main {
            padding: 2.5rem 0 3.5rem;
            display: grid;
            gap: 1.5rem;
        }

        .card,
        .control-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 18px 30px -24px rgba(15, 23, 42, 0.45);
        }

        .controls {
            display: grid;
            gap: 1.25rem;
        }

        form#filters-form {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            align-items: end;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--muted);
            display: block;
        }

        label span {
            display: block;
            margin-bottom: 0.35rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 0.95rem;
        }

        button {
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.7rem 1.4rem;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        button[type="submit"] {
            background: var(--accent);
            color: #fff;
        }

        button.secondary {
            background: var(--accent-muted);
            color: var(--accent);
        }

        button:disabled {
            opacity: 0.6;
            cursor: wait;
            transform: none !important;
            box-shadow: none !important;
        }

        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 18px -14px rgba(79, 70, 229, 0.9);
        }

        .status-line {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .status-message[data-state="error"] {
            color: var(--high);
            font-weight: 600;
        }

        .status-message[data-state="success"] {
            color: var(--low);
        }

        .summary-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .metric-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.6rem;
            box-shadow: 0 16px 28px -30px rgba(79, 70, 229, 0.6);
            border: 1px solid rgba(79, 70, 229, 0.05);
        }

        .metric-label {
            color: var(--muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08rem;
        }

        .metric-value {
            display: block;
            margin-top: 0.35rem;
            font-size: clamp(1.75rem, 3.5vw, 2.4rem);
            font-weight: 700;
        }

        h2 {
            margin: 0 0 1rem;
            font-size: 1.3rem;
        }

        .risk-list {
            display: grid;
            gap: 0.85rem;
        }

        .risk-row {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: 130px 1fr 70px;
            align-items: center;
            font-size: 0.95rem;
        }

        .risk-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .risk-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block;
        }

        .risk-bar {
            background: var(--border);
            border-radius: 999px;
            overflow: hidden;
            height: 10px;
            position: relative;
        }

        .risk-fill {
            height: 100%;
            border-radius: inherit;
        }

        .risk-fill.high { background: var(--high); }
        .risk-fill.medium { background: var(--medium); }
        .risk-fill.low { background: var(--low); }
        .risk-fill.unknown { background: var(--unknown); }

        .empty-state {
            color: var(--muted);
            font-style: italic;
            padding: 0.5rem 0 0.75rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.92rem;
        }

        th {
            background: rgba(79, 70, 229, 0.05);
            font-weight: 600;
            color: var(--muted);
            white-space: nowrap;
        }

        tbody tr:hover {
            background: rgba(79, 70, 229, 0.04);
        }

        .risk-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05rem;
        }

        .risk-chip.high { background: rgba(220, 38, 38, 0.12); color: var(--high); }
        .risk-chip.medium { background: rgba(245, 158, 11, 0.14); color: var(--medium); }
        .risk-chip.low { background: rgba(22, 163, 74, 0.14); color: var(--low); }
        .risk-chip.unknown { background: rgba(107, 114, 128, 0.16); color: var(--unknown); }

        .risk-event {
            display: grid;
            gap: 0.4rem;
            grid-template-columns: auto 1fr;
            align-items: baseline;
            margin-bottom: 0.4rem;
        }

        .risk-event span.meta {
            color: var(--muted);
            font-size: 0.8rem;
        }

        @media (max-width: 780px) {
            .risk-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.5rem;
            }

            .risk-row > :last-child {
                order: 3;
            }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <div class="container">
            <h1>แดชบอร์ดการดูแลผู้ใช้</h1>
            <p>ติดตามสถานะการสนทนาและสัญญาณความเสี่ยงเพื่อสนับสนุนทีมบำบัดแบบเรียลไทม์</p>
        </div>
    </header>

    <main class="container">
        <section class="control-card">
            <div class="controls">
                <form id="filters-form">
                    <label>
                        <span>จำนวนผู้ใช้สูงสุด</span>
                        <input type="number" id="user-limit" name="limit" min="1" max="100" value="10" required>
                    </label>
                    <label>
                        <span>ช่วงข้อมูล (วัน)</span>
                        <input type="number" id="lookback-days" name="lookback_days" min="1" max="180" value="30" required>
                    </label>
                    <label>
                        <span>จำนวนคีย์เวิร์ดยอดนิยม</span>
                        <input type="number" id="keyword-limit" name="keyword_limit" min="1" max="50" value="10" required>
                    </label>
                    <button type="submit" id="load-button">โหลดข้อมูล</button>
                    <button type="button" id="refresh-button" class="secondary">รีเฟรช</button>
                </form>

                <div class="status-line">
                    <span class="status-message" id="status-message" data-state="info">พร้อมใช้งาน</span>
                    <span class="timestamp" id="last-updated">อัปเดตล่าสุด: -</span>
                </div>
            </div>
        </section>

        <section class="summary-grid" aria-live="polite">
            <article class="metric-card">
                <span class="metric-label">บทสนทนาทั้งหมด</span>
                <span class="metric-value" id="total-conversations">--</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">ผู้ใช้ที่มีปฏิสัมพันธ์</span>
                <span class="metric-value" id="unique-users">--</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">ข้อความสำคัญที่ถูกตั้งธง</span>
                <span class="metric-value" id="important-messages">--</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">ติดตามผลที่ยังดำเนินการ</span>
                <span class="metric-value" id="active-follow-ups">--</span>
            </article>
        </section>

        <section class="card" aria-live="polite">
            <h2>ภาพรวมระดับความเสี่ยง</h2>
            <div id="risk-summary" class="risk-list" role="list">
                <div class="empty-state">กำลังโหลด...</div>
            </div>
        </section>

        <section class="card" aria-live="polite">
            <h2>คีย์เวิร์ดยอดนิยม</h2>
            <div id="keywords-empty" class="empty-state">กำลังโหลด...</div>
            <div class="table-wrapper">
                <table id="keywords-table" hidden>
                    <thead>
                        <tr>
                            <th>คำสำคัญ</th>
                            <th>จำนวนครั้ง</th>
                            <th>ระดับความเสี่ยง</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="card" aria-live="polite">
            <h2>เส้นทางผู้ใช้ล่าสุด</h2>
            <div id="users-empty" class="empty-state">กำลังโหลด...</div>
            <div class="table-wrapper">
                <table id="users-table" hidden>
                    <thead>
                        <tr>
                            <th>ผู้ใช้</th>
                            <th>ข้อความทั้งหมด</th>
                            <th>ข้อความสำคัญ</th>
                            <th>สัดส่วนสำคัญ</th>
                            <th>โทเค็นรวม</th>
                            <th>ปฏิสัมพันธ์ล่าสุด</th>
                            <th>เหตุการณ์เสี่ยงล่าสุด</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const filtersForm = document.getElementById('filters-form');
        const loadButton = document.getElementById('load-button');
        const refreshButton = document.getElementById('refresh-button');
        const statusMessage = document.getElementById('status-message');
        const lastUpdated = document.getElementById('last-updated');

        const summaryTargets = {
            total_conversations: document.getElementById('total-conversations'),
            unique_users: document.getElementById('unique-users'),
            important_messages: document.getElementById('important-messages'),
            active_follow_ups: document.getElementById('active-follow-ups')
        };

        const riskSummaryContainer = document.getElementById('risk-summary');
        const keywordsTable = document.getElementById('keywords-table');
        const keywordsEmpty = document.getElementById('keywords-empty');
        const usersTable = document.getElementById('users-table');
        const usersEmpty = document.getElementById('users-empty');

        const riskLabels = {
            high: 'สูง',
            medium: 'ปานกลาง',
            low: 'ต่ำ',
            unknown: 'ไม่ระบุ',
            contextual: 'บริบท'
        };

        function setLoading(isLoading) {
            loadButton.disabled = isLoading;
            refreshButton.disabled = isLoading;
            statusMessage.textContent = isLoading ? 'กำลังดึงข้อมูล...' : 'พร้อมใช้งาน';
            statusMessage.dataset.state = isLoading ? 'info' : 'success';
        }

        function setError(message) {
            statusMessage.textContent = message;
            statusMessage.dataset.state = 'error';
        }

        function formatNumber(value) {
            return Number.isFinite(value) ? value.toLocaleString('th-TH') : '--';
        }

        function formatPercent(value) {
            if (!Number.isFinite(value)) {
                return '--';
            }
            return (value * 100).toFixed(1) + '%';
        }

        function formatTimestamp(value) {
            if (!value) {
                return '-';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleString('th-TH', { hour12: false });
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function updateSummary(overview) {
            Object.entries(summaryTargets).forEach(([key, el]) => {
                el.textContent = formatNumber(overview?.[key]);
            });
        }

        function updateRiskSummary(summary) {
            const entries = Object.entries(summary || {});
            const total = entries.reduce((acc, [, value]) => acc + (Number(value) || 0), 0);

            if (!entries.length || total === 0) {
                riskSummaryContainer.innerHTML = '<div class="empty-state">ยังไม่มีข้อมูลความเสี่ยงที่บันทึกไว้</div>';
                return;
            }

            riskSummaryContainer.innerHTML = '';
            entries.forEach(([level, value]) => {
                const amount = Number(value) || 0;
                const percentage = total ? Math.round((amount / total) * 100) : 0;
                const row = document.createElement('div');
                row.className = 'risk-row';
                row.setAttribute('role', 'listitem');

                row.innerHTML = `
                    <div class="risk-label">
                        <span class="risk-dot risk-fill ${level}"></span>
                        <span>${escapeHtml(riskLabels[level] || level)}</span>
                    </div>
                    <div class="risk-bar">
                        <div class="risk-fill ${level}" style="width: ${percentage}%;"></div>
                    </div>
                    <div>${formatNumber(amount)}</div>
                `;

                riskSummaryContainer.appendChild(row);
            });
        }

        function updateKeywords(keywords) {
            const list = Array.isArray(keywords) ? keywords : [];
            if (!list.length) {
                keywordsTable.hidden = true;
                keywordsEmpty.textContent = 'ยังไม่พบคีย์เวิร์ดที่ถูกพูดถึงบ่อยในช่วงเวลาที่เลือก';
                keywordsEmpty.hidden = false;
                return;
            }

            const tbody = keywordsTable.querySelector('tbody');
            tbody.innerHTML = '';
            list.forEach(item => {
                const row = document.createElement('tr');
                const riskLevel = item.risk_level || 'unknown';
                row.innerHTML = `
                    <td>${escapeHtml(item.keyword)}</td>
                    <td>${formatNumber(item.count)}</td>
                    <td><span class="risk-chip ${riskLevel}">${escapeHtml(riskLabels[riskLevel] || riskLevel)}</span></td>
                `;
                tbody.appendChild(row);
            });

            keywordsEmpty.hidden = true;
            keywordsTable.hidden = false;
        }

        function updateUsers(users) {
            const list = Array.isArray(users) ? users : [];
            if (!list.length) {
                usersTable.hidden = true;
                usersEmpty.textContent = 'ยังไม่มีผู้ใช้ที่มีการสนทนาล่าสุดในช่วงเวลาที่เลือก';
                usersEmpty.hidden = false;
                return;
            }

            const tbody = usersTable.querySelector('tbody');
            tbody.innerHTML = '';
            list.forEach(user => {
                const row = document.createElement('tr');
                const importantRatio = Number(user.important_ratio) || 0;
                const recentEvents = Array.isArray(user.recent_risk_events) ? user.recent_risk_events : [];

                const eventsHtml = recentEvents.length
                    ? recentEvents.map(event => {
                        const level = event.risk_level || 'unknown';
                        const keywords = Array.isArray(event.keywords) ? event.keywords.join(', ') : '-';
                        return `
                            <div class="risk-event">
                                <span class="risk-chip ${level}">${escapeHtml(riskLabels[level] || level)}</span>
                                <span class="meta">${formatTimestamp(event.timestamp)} • ${escapeHtml(keywords || '-')}</span>
                            </div>
                        `;
                    }).join('')
                    : '<span class="meta">-</span>';

                row.innerHTML = `
                    <td>${escapeHtml(user.user_id)}</td>
                    <td>${formatNumber(user.total_messages)}</td>
                    <td>${formatNumber(user.important_messages)}</td>
                    <td>${formatPercent(importantRatio)}</td>
                    <td>${formatNumber(user.total_tokens)}</td>
                    <td>${formatTimestamp(user.last_interaction)}</td>
                    <td>${eventsHtml}</td>
                `;

                tbody.appendChild(row);
            });

            usersEmpty.hidden = true;
            usersTable.hidden = false;
        }

        async function loadInsights() {
            const formData = new FormData(filtersForm);
            const params = new URLSearchParams(formData);
            setLoading(true);
            try {
                const response = await fetch(`/api/dashboard/insights?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`เซิร์ฟเวอร์ตอบกลับสถานะ ${response.status}`);
                }
                const data = await response.json();
                updateSummary(data.overview);
                updateRiskSummary(data.risk_summary);
                updateKeywords(data.top_keywords);
                updateUsers(data.users);

                const generatedAt = data.generated_at ? formatTimestamp(data.generated_at) : '-';
                lastUpdated.textContent = `อัปเดตล่าสุด: ${generatedAt}`;
                statusMessage.textContent = 'โหลดข้อมูลสำเร็จ';
                statusMessage.dataset.state = 'success';
            } catch (error) {
                console.error('โหลดแดชบอร์ดไม่สำเร็จ:', error);
                setError('ไม่สามารถโหลดข้อมูลได้ ตรวจสอบเซิร์ฟเวอร์หรือเครือข่าย');
            } finally {
                setLoading(false);
            }
        }

        filtersForm.addEventListener('submit', event => {
            event.preventDefault();
            loadInsights();
        });

        refreshButton.addEventListener('click', () => loadInsights());

        document.addEventListener('DOMContentLoaded', () => {
            loadInsights();
        });
    </script>
</body>
</html>
