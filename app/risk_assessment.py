"""Risk assessment utilities for the Jai Dee chatbot."""
import json
import logging
from datetime import datetime
from typing import Dict, Tuple, List

redis_client = None

# ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡πÅ‡∏•‡∏á ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ó‡∏±‡∏ö‡∏®‡∏±‡∏û‡∏ó‡πå)
RISK_KEYWORDS = {
    "high_risk": [
        # ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏¢/‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        "‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏¢", "‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á", "‡∏Ñ‡∏¥‡∏î‡∏™‡∏±‡πâ‡∏ô", "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏ï‡∏≤‡∏¢", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï",
        "‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏≤‡∏¢‡πÑ‡∏õ", "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", "‡∏à‡∏ö‡πÜ‡πÑ‡∏õ", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏ö‡πÜ", "‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡πÇ‡∏•‡∏Å‡∏ô‡∏µ‡πâ",
        "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ï‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏≠‡∏µ‡∏Å", "‡∏Ç‡∏≠‡∏ï‡∏≤‡∏¢", "‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏õ‡∏Å‡πá‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", "‡∏´‡∏°‡∏î‡∏´‡∏ô‡∏ó‡∏≤‡∏á", "‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å",
        # ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
        "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î", "overdose", "od", "OD", "OD'd", "‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô", "‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î",
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å", "‡∏ä‡∏±‡∏Å", "‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥", "‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î", "‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å", "‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å",
        # ‡∏ß‡∏•‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏™‡πÅ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        "suicide", "kill myself", "kms", "kys", "unalive", "end it", "i want to die",
        "i can‚Äôt go on", "hope i don‚Äôt wake up",
        # ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏°‡∏≤‡∏Ñ‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á
        "üî™", "ü©∏", "üíä", "‚ö∞Ô∏è", "ü™¶", "üòñ", "üòû", "üò≠",
    ],
    "medium_risk": [
        # ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤ ‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏• ‡πÄ‡∏´‡∏á‡∏≤ ‡∏ó‡πâ‡∏≠
        "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö", "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î", "‡∏Å‡∏±‡∏á‡∏ß‡∏•", "‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•",
        "‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤", "‡πÄ‡∏®‡∏£‡πâ‡∏≤", "‡∏´‡∏î‡∏´‡∏π‡πà", "‡πÄ‡∏´‡∏á‡∏≤", "‡∏ó‡πâ‡∏≠‡πÅ‡∏ó‡πâ", "‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏ß‡∏±‡∏á",
        "‡∏´‡∏°‡∏î‡πÑ‡∏ü", "‡∏´‡∏°‡∏î‡πÅ‡∏£‡∏á‡πÉ‡∏à", "‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡πâ‡∏ß", "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ", "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡πÑ‡∏´‡∏•",
        "‡πÑ‡∏£‡πâ‡∏Ñ‡πà‡∏≤", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≤", "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç", "‡πÇ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß",
        "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏≤‡∏¢‡πÄ‡∏á‡∏µ‡∏¢‡∏ö", "‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô",
        "‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï", "‡∏Ñ‡∏¥‡∏î‡∏°‡∏≤‡∏Å", "‡∏ù‡∏±‡∏ô‡∏£‡πâ‡∏≤‡∏¢", "‡∏Å‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏•‡∏á", "‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
        # ‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£/‡∏™‡πÅ‡∏•‡∏á/‡∏ó‡∏±‡∏ö‡∏®‡∏±‡∏û‡∏ó‡πå/‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
        "‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏¢‡∏≤", "‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏™‡∏û", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏™‡∏û", "‡πÄ‡∏™‡∏µ‡πâ‡∏¢‡∏ô", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏¢‡∏≤", "‡∏•‡∏á‡πÅ‡∏î‡∏á",
        "‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", "‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", "‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", "‡∏ï‡∏¥‡∏î‡∏¢‡∏≤", "‡∏ï‡∏¥‡∏î‡πÄ‡∏´‡∏•‡πâ‡∏≤", "‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",
        "‡∏£‡∏µ‡πÅ‡∏•‡πá‡∏õ‡∏™‡πå", "‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ", "‡∏´‡∏•‡∏∏‡∏î", "‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏Ñ‡∏•‡∏ô", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏µ‡πÅ‡∏•‡∏õ", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ",
        # ‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå/‡∏ô‡∏¥‡πÇ‡∏Ñ‡∏ï‡∏¥‡∏ô
        "‡πÄ‡∏´‡∏•‡πâ‡∏≤", "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", "‡πÑ‡∏ß‡∏ô‡πå", "‡∏™‡∏∏‡∏£‡∏≤", "‡πÄ‡∏°‡∏≤", "‡πÄ‡∏°‡∏≤‡∏¢‡∏≤", "‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏´‡∏•‡πâ‡∏≤", "‡∏ñ‡∏≠‡∏ô‡πÄ‡∏´‡∏•‡πâ‡∏≤",
        "‡∏ô‡∏¥‡πÇ‡∏Ñ‡∏ï‡∏¥‡∏ô", "‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", "‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", "vape", "‡πÄ‡∏ß‡∏õ", "pod", "‡∏û‡∏≠‡∏î",
        # ‡πÅ‡∏≠‡∏°‡πÄ‡∏ü‡∏ï‡∏≤‡∏°‡∏µ‡∏ô/‡πÄ‡∏°‡∏ó‡πÅ‡∏≠‡∏°‡πÄ‡∏ü‡∏ï‡∏≤‡∏°‡∏µ‡∏ô
        "‡∏¢‡∏≤‡∏ö‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ö‡πà‡πâ‡∏≤", "‡∏¢‡∏≤‡∏ö‡∏≤", "‡∏¢‡∏≤‡∏Ç‡∏±‡∏ö", "‡∏¢‡∏≤‡∏ü‡πâ‡∏≤", "yaba", "‡πÄ‡∏°‡∏ó‡πÅ‡∏≠‡∏°‡πÄ‡∏ü‡∏ï‡∏≤‡∏°‡∏µ‡∏ô",
        "‡πÄ‡∏°‡∏ó‡∏Ø", "‡πÄ‡∏°‡∏ó", "‡πÄ‡∏°‡∏ó‡πÅ‡∏≠‡∏°", "‡πÑ‡∏≠‡∏ã‡πå", "‡∏¢‡∏≤‡πÑ‡∏≠‡∏ã‡πå", "ice", "‡∏ä‡∏≤‡∏ö‡∏π", "shabu",
        # ‡∏Å‡∏±‡∏ç‡∏ä‡∏≤/‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°
        "‡∏Å‡∏±‡∏ç‡∏ä‡∏≤", "weed", "‡∏Å‡∏±‡∏ç", "‡∏Å‡∏±‡∏ç‡∏Ø", "‡∏Å‡∏±‡∏ç‡∏ä‡∏á", "‡∏Ñ‡∏≤‡∏ô‡∏≤‡πÄ‡∏ö‡∏¥‡∏™", "cannabis", "‡∏Å‡∏±‡∏ç‡∏ä‡∏≤‡∏≠‡∏±‡∏î‡πÅ‡∏ó‡πà‡∏á",
        "‡∏ö‡πâ‡∏≠‡∏á", "‡∏î‡∏π‡∏î‡∏ö‡πâ‡∏≠‡∏á", "‡∏î‡∏π‡∏î‡∏Å‡∏±‡∏ç", "‡∏™‡∏π‡∏ö‡∏Å‡∏±‡∏ç", "‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°", "‡πÉ‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°", "‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏≠‡∏°",
        "‡πÑ‡∏°‡∏ó‡∏£‡∏≤‡πÑ‡∏à‡∏ô‡∏µ‡∏ô", "kratom", "‡∏™‡∏µ‡πà‡∏Ñ‡∏π‡∏ì‡∏£‡πâ‡∏≠‡∏¢", "4x100", "4*100",
        # ‡πÇ‡∏≠‡∏õ‡∏¥‡∏≠‡∏≠‡∏¢‡∏î‡πå/‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î‡πÅ‡∏£‡∏á
        "‡πÄ‡∏Æ‡πÇ‡∏£‡∏≠‡∏µ‡∏ô", "‡∏°‡∏≠‡∏£‡πå‡∏ü‡∏µ‡∏ô", "‡πÇ‡∏Ñ‡πÄ‡∏î‡∏≠‡∏µ‡∏ô", "‡πÄ‡∏ü‡∏ô‡∏ó‡∏≤‡∏ô‡∏¥‡∏•", "fentanyl", "‡∏ù‡∏¥‡πà‡∏ô", "opiate", "opioid",
        "‡∏ó‡∏£‡∏¥‡∏°‡∏≤‡∏î‡∏≠‡∏•", "tramadol", "‡∏≠‡∏≠‡∏Å‡∏ã‡∏µ‡πà", "oxycodone", "‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÇ‡∏Ñ‡πÇ‡∏î‡∏ô",
        # ‡πÄ‡∏ö‡∏ô‡πÇ‡∏ã‡πÑ‡∏î‡∏≠‡∏∞‡∏ã‡∏µ‡∏û‡∏µ‡∏ô/‡∏¢‡∏≤‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö
        "‡πÄ‡∏ö‡∏ô‡πÇ‡∏ã", "benzodiazepine", "‡πÑ‡∏î‡∏≠‡∏∞‡∏ã‡∏µ‡πÅ‡∏û‡∏°", "diazepam", "‡∏≠‡∏±‡∏•‡∏û‡∏£‡∏≤‡πÇ‡∏ã‡πÅ‡∏•‡∏°", "alprazolam",
        "‡πÅ‡∏ã‡πÅ‡∏ô‡∏Å‡∏ã‡πå", "xanax", "‡πÇ‡∏Ñ‡∏•‡∏ô‡∏≤‡∏ã‡∏µ‡πÅ‡∏û‡∏°", "clonazepam", "‡∏¢‡∏≤‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö", "‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ï‡∏∑‡πà‡∏ô",
        # ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô/‡∏´‡∏•‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó/‡∏Ñ‡∏•‡∏±‡∏ö‡∏î‡∏£‡∏±‡∏Å
        "‡πÇ‡∏Ñ‡πÄ‡∏Ñ‡∏ô", "cocaine", "‡πÇ‡∏Ñ‡∏Ñ", "‡πÄ‡∏Ñ‡∏ï‡∏≤‡∏°‡∏µ‡∏ô", "ketamine", "‡πÄ‡∏Ñ", "‡∏¢‡∏≤‡πÄ‡∏Ñ",
        "MDMA", "‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡∏ï‡∏≤‡∏ã‡∏µ", "‡∏¢‡∏≤‡∏≠‡∏µ", "E", "‡∏¢‡∏≤X", "LSD", "‡πÄ‡∏´‡πá‡∏î‡πÄ‡∏°‡∏≤", "shrooms",
        "‡∏î‡∏°‡∏Å‡∏≤‡∏ß", "‡∏Å‡∏≤‡∏ß", "‡∏ó‡∏¥‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå", "‡∏™‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢", "‡πÅ‡∏Å‡πä‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞", "nitrous", "NO2", "balloon",
        "GHB", "‡∏¢‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏≤‡∏ß", "‡∏Å‡∏≤‡∏ö‡∏≤", "gamma-hydroxybutyrate",
        # ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠/‡∏ô‡πâ‡∏≥‡πÅ‡∏î‡∏á/‡∏ú‡∏™‡∏°
        "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠", "‡πÑ‡∏≠‡∏ó‡∏¥‡∏•", "‡∏ô‡πâ‡∏≥‡πÅ‡∏î‡∏á", "‡∏¢‡∏≤‡∏ô‡πâ‡∏≥", "‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏≠‡∏°+‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏≠", "‡∏™‡∏µ‡πà‡∏Ñ‡∏π‡∏ì‡∏£‡πâ‡∏≠‡∏¢‡∏ô‡πâ‡∏≥‡πÅ‡∏î‡∏á",
        # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ/‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
        "‡πÄ‡∏™‡∏û", "‡∏â‡∏µ‡∏î", "‡∏™‡∏π‡∏ö", "‡∏î‡∏°", "‡πÄ‡∏Ñ‡∏µ‡πâ‡∏¢‡∏ß", "‡∏ï‡πâ‡∏°‡∏Å‡∏¥‡∏ô", "‡∏ú‡∏™‡∏°", "‡∏ï‡∏µ‡∏Ç‡∏≠‡∏á", "‡∏ï‡∏∏‡πã‡∏ô‡∏ó‡πà‡∏≠‡∏°",
        "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡∏ß‡∏ô", "‡∏ß‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ", "‡∏Ñ‡∏•‡∏±‡∏ö", "‡∏ö‡∏≤‡∏£‡πå", "‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏Å‡πà‡∏≤", "‡∏Ç‡∏≠‡∏á‡∏°‡∏≤",
        "‡∏´‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á", "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≤‡∏î", "‡∏ñ‡∏≠‡∏ô‡∏¢‡∏≤", "‡∏î‡∏µ‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå", "detox", "rehab", "‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏≥‡∏ö‡∏±‡∏î",
        # ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô/‡∏ú‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
        "‡πÄ‡∏™‡∏µ‡πâ‡∏¢‡∏ô‡∏¢‡∏≤", "‡∏Å‡∏£‡∏∞‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡∏ß‡∏≤‡∏¢", "‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î", "‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏Å", "‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô", "‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô",
        "‡∏õ‡∏ß‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢", "‡∏õ‡∏ß‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å", "‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ", "‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô", "‡∏´‡∏ô‡∏≤‡∏ß‡∏™‡∏±‡πà‡∏ô", "‡∏Ç‡∏ô‡∏•‡∏∏‡∏Å",
        "‡πÄ‡∏û‡πâ‡∏≠", "‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏´‡∏•‡∏≠‡∏ô", "‡∏´‡∏π‡πÅ‡∏ß‡πà‡∏ß", "‡∏ï‡∏≤‡∏ù‡∏≤‡∏î", "‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà",
        # ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ó‡∏±‡∏ö‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏•‡∏≤‡∏á
        "depressed", "depression", "anxious", "anxiety", "panic", "lonely", "hopeless",
        "relapse", "craving", "urge", "can‚Äôt sleep", "insomnia", "stress",
        # ‡∏ß‡∏•‡∏µ‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡πà‡∏≠‡∏¢
        "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏ô‡∏µ‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡πÜ", "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÉ‡∏à", "‡πÉ‡∏à‡∏û‡∏±‡∏á",
        "‡πÅ‡∏ö‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß", "‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏°‡∏±‡∏ô‡∏´‡∏ô‡∏±‡∏Å", "‡∏ó‡πâ‡∏≠‡∏à‡∏ô‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏∂‡πà‡∏á‡∏¢‡∏≤", "‡∏Ç‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏£‡∏á‡πÜ",
        # ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏•‡∏ö/‡∏™‡∏≤‡∏£
        "üòî", "üò¢", "üò©", "ü•∫", "üíî", "üç∫", "üçª", "üç∑", "üö¨", "üí®", "üíâ", "üß™",
    ],
}


# ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á
MEDIUM_RISK_THRESHOLD = 2


def init_risk_assessment(redis_instance) -> None:
    """Initialize Redis client for risk assessment."""
    global redis_client
    redis_client = redis_instance


def assess_risk(message: str) -> Tuple[str, List[str]]:
    """Assess risk level from message.

    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "high" ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á
    ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    """
    message = message.lower()
    matched_keywords: List[str] = []

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏Ñ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á
    for keyword in RISK_KEYWORDS["high_risk"]:
        if keyword in message:
            matched_keywords.append(keyword)

    if matched_keywords:
        return "high", matched_keywords

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏Ñ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
    medium_matches = [kw for kw in RISK_KEYWORDS["medium_risk"] if kw in message]
    matched_keywords.extend(medium_matches)

    if len(medium_matches) >= MEDIUM_RISK_THRESHOLD:
        return "high", matched_keywords
    elif medium_matches:
        return "medium", matched_keywords

    return "low", matched_keywords


def save_progress_data(user_id: str, risk_level: str, keywords: List[str]) -> None:
    """Save user progress data to Redis."""
    try:
        progress_data = {
            'timestamp': datetime.now().isoformat(),
            'risk_level': risk_level,
            'keywords': keywords
        }
        redis_client.lpush(f"progress:{user_id}", json.dumps(progress_data))
        redis_client.ltrim(f"progress:{user_id}", 0, 99)
    except Exception as e:
        logging.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤: {str(e)}")


def generate_progress_report(user_id: str) -> str:
    """Generate a progress report for the user."""
    try:
        progress_data = redis_client.lrange(f"progress:{user_id}", 0, -1)
        if not progress_data:
            return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤"

        data = [json.loads(item) for item in progress_data]
        risk_trends = {
            'high': sum(1 for d in data if d['risk_level'] == 'high'),
            'medium': sum(1 for d in data if d['risk_level'] == 'medium'),
            'low': sum(1 for d in data if d['risk_level'] == 'low')
        }
        report = (
            "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤\n\n"
            f"üìÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: {data[-1]['timestamp'][:10]} ‡∏ñ‡∏∂‡∏á {data[0]['timestamp'][:10]}\n"
            f"üìà ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:\n"
            f"‚ñ´Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á: {risk_trends['high']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
            f"‚ñ´Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á: {risk_trends['medium']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
            f"‚ñ´Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥: {risk_trends['low']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
        )
        return report
    except Exception as e:
        logging.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤: {str(e)}")
        return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ"
